<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Profile</title>

  <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
  <link rel="stylesheet" href="/static/site.css">
  <link rel="stylesheet" href="/static/tailwind.generated.css">

  <style>
    #lightbox { transition: opacity 0.2s ease; }
    #lightbox.hidden { pointer-events: none; }
    #lightboxImg { transition: transform 0.2s ease, opacity 0.2s ease; }
  </style>
</head>

<body class="bg-creamsicle-bg min-h-screen flex flex-col">

  <!-- Sidebar -->
  <div class="profile-sidebar">
    <button class="w-12 h-12 rounded-full border border-orange-200 bg-white/60 backdrop-blur flex items-center justify-center hover:scale-105 transition">üì§</button>
    <button class="w-12 h-12 rounded-full border border-orange-200 bg-white/60 backdrop-blur flex items-center justify-center hover:scale-105 transition">üñºÔ∏è</button>
    <button class="w-12 h-12 rounded-full border border-orange-200 bg-white/60 backdrop-blur flex items-center justify-center hover:scale-105 transition">üè∑Ô∏è</button>
    <button class="w-12 h-12 rounded-full border border-orange-200 bg-white/60 backdrop-blur flex items-center justify-center hover:scale-105 transition">‚öôÔ∏è</button>
  </div>

  <!-- Navbar -->
  <header class="app-header px-10 py-6">
    <div class="brand-group flex items-center gap-4">
      <div class="w-10 h-10 rounded-full border border-orange-200 flex items-center justify-center font-semibold">TL</div>
      <span class="text-lg font-medium tracking-tight">Tag Lens</span>
    </div>

    <nav class="app-nav flex items-center gap-4">
      <a href="/" class="h-11 px-6 rounded-full border border-orange-200 bg-white/50 flex items-center text-sm font-medium hover:bg-orange-50 transition">Home</a>
      <a href="/dashboard" class="h-11 px-6 rounded-full border border-orange-200 bg-white/50 flex items-center text-sm font-medium hover:bg-orange-50 transition">Dashboard</a>
      <a href="/profile" class="h-11 px-6 rounded-full border border-orange-200 bg-white/50 flex items-center text-sm font-medium hover:bg-orange-50 transition">Profile</a>
    </nav>

    <div class="user-chip flex items-center gap-3">
      <span class="text-sm text-gray-600">{{ user.username }}</span>
      <img src="/static/avatar.svg" class="w-9 h-9 rounded-full border border-orange-200" />
    </div>
  </header>

  <main class="profile-main flex-grow pl-32 pr-12 pt-20 pb-32">

    <!-- Profile Card -->
    <div class="max-w-6xl mx-auto mb-20">
      <div class="bg-white/70 backdrop-blur border border-orange-300 rounded-3xl p-10 shadow-sm">
        <div class="flex items-center justify-between">

          <div class="flex items-center gap-6">
            <img src="/static/avatar.svg" class="w-20 h-20 rounded-full border border-orange-300" />
            <div class="text-left">
              <h2 class="text-2xl font-semibold text-gray-900">{{ user.username }}</h2>
              <p class="text-sm text-gray-500 mt-1">{{ user.email }}</p>
              <p class="text-xs text-gray-400 mt-2">Member since {{ user.created_at.strftime('%B %d, %Y') }}</p>
            </div>
          </div>

          <!-- Stats -->
          <div class="flex items-center">
            <p id="photosCount" class="text-4xl font-light text-gray-400">0</p>
            <p class="text-lg text-gray-400 ml-2">Photos</p>
          </div>

        </div>
      </div>
    </div>

    <!-- Gallery -->
    <div class="max-w-6xl mx-auto px-10">
      <div class="mb-6 flex flex-wrap items-center justify-between gap-4">
        <h3 class="text-2xl font-semibold text-gray-900">Your Gallery</h3>
        <div class="flex items-center gap-3">
          <label for="sortBy" class="text-sm text-gray-600">Sort by</label>
          <select id="sortBy" class="rounded-full border border-orange-300 bg-white/80 px-3 py-2 text-sm">
            <option value="uploaded">Date Uploaded</option>
            <option value="taken">Date Taken</option>
          </select>
          <select id="sortOrder" class="rounded-full border border-orange-300 bg-white/80 px-3 py-2 text-sm">
            <option value="desc">Newest first</option>
            <option value="asc">Oldest first</option>
          </select>
        </div>
      </div>

      <div id="galleryGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
    </div>

  </main>

  <!-- Lightbox -->
  <div id="lightbox"
       class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm"
       onclick="closeLightbox(event)">

    <div class="relative max-w-5xl w-full mx-6" onclick="event.stopPropagation()">

      <!-- Top bar -->
      <div class="flex items-center justify-between mb-3 px-1">
        <p id="lightboxCaption" class="text-white/80 text-sm truncate max-w-lg"></p>
        <div class="flex items-center gap-3">
          <!-- Delete button -->
          <button id="lightboxDelete"
                  onclick="deleteCurrentPhoto()"
                  class="flex items-center gap-1.5 px-4 py-1.5 rounded-full 
                         bg-red-500/20 border border-red-400/40 
                         text-red-300 text-sm font-medium
                         hover:bg-red-500/40 transition">
            üóë Delete
          </button>
          <!-- Close button -->
          <button onclick="closeLightbox()"
                  class="flex items-center justify-center w-8 h-8 rounded-full 
                         bg-white/10 border border-white/20 text-white
                         hover:bg-white/20 transition text-lg leading-none">
            ‚úï
          </button>
        </div>
      </div>

      <!-- Image -->
      <img id="lightboxImg"
           src=""
           alt=""
           class="w-full max-h-[80vh] object-contain rounded-2xl shadow-2xl" />

    </div>
  </div>

  <!-- Delete confirm modal -->
  <div id="deleteModal"
       class="hidden fixed inset-0 z-60 flex items-center justify-center bg-black/60"
       onclick="closeDeleteModal(event)">
    <div class="bg-white rounded-2xl p-8 max-w-sm w-full mx-6 shadow-xl" onclick="event.stopPropagation()">
      <h3 class="text-lg font-semibold text-gray-900 mb-2">Delete photo?</h3>
      <p class="text-sm text-gray-500 mb-6">This can't be undone. The photo will be permanently removed.</p>
      <div class="flex gap-3">
        <button onclick="closeDeleteModal()"
                class="flex-1 py-2 rounded-full border border-gray-200 text-sm text-gray-600 hover:bg-gray-50 transition">
          Cancel
        </button>
        <button id="confirmDeleteBtn"
                class="flex-1 py-2 rounded-full bg-red-500 text-white text-sm font-medium hover:bg-red-600 transition">
          Delete
        </button>
      </div>
    </div>
  </div>

  <!-- Notice modal -->
  <div id="noticeModal"
       class="hidden fixed inset-0 flex items-center justify-center bg-black/50 px-6"
       style="z-index: 70;"
       onclick="closeNoticeModal(event)">
    <div class="w-full max-w-sm rounded-2xl border border-orange-200 bg-white p-6 shadow-2xl" onclick="event.stopPropagation()">
      <div class="mb-3 flex items-center justify-between">
        <h3 id="noticeTitle" class="text-lg font-semibold text-gray-900">Notice</h3>
        <button onclick="closeNoticeModal()"
                class="h-8 w-8 rounded-full border border-orange-200 text-gray-500 transition hover:bg-orange-50">
          ‚úï
        </button>
      </div>
      <p id="noticeMessage" class="text-sm text-gray-600 mb-6"></p>
      <button id="noticeCloseBtn"
              onclick="closeNoticeModal()"
              class="w-full rounded-full bg-creamsicle-primary py-2 text-sm font-medium text-white transition hover:opacity-90">
        Close
      </button>
    </div>
  </div>

  <script>
    function getCsrfToken() {
      const match = document.cookie.match(/(?:^|;\s*)taglens_csrf=([^;]*)/);
      return match ? decodeURIComponent(match[1]) : "";
    }

    let currentPhotoId = null;

    // ‚îÄ‚îÄ Gallery ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadGallery() {
      const sortBy = document.getElementById("sortBy").value;
      const sortOrder = document.getElementById("sortOrder").value;

      let data;
      try {
        const res = await fetch(`/api/profile?sort_by=${sortBy}&order=${sortOrder}`);
        if (!res.ok) throw new Error(`Server error (${res.status})`);
        data = await res.json();
      } catch (e) {
        showNotice({ title: "Load Failed", message: "Could not load gallery. Please refresh." });
        return;
      }

      const grid = document.getElementById("galleryGrid");
      while (grid.firstChild) grid.removeChild(grid.firstChild);
      document.getElementById("photosCount").textContent = data.photos.length;

      for (const photo of data.photos) {
        const fullSrc = `/api/photos/view?photo_id=${photo.id}`;
        const thumbSrc = `/api/photos/thumb?photo_id=${photo.id}`;
        const caption = photo.description || photo.filename;

        const card = document.createElement("div");
        card.className = "relative group rounded-xl overflow-hidden cursor-pointer";
        card.dataset.photoId = photo.id;
        card.dataset.caption = caption;
        card.dataset.src = fullSrc;

        const img = document.createElement("img");
        img.src = thumbSrc;
        img.loading = "lazy";
        img.decoding = "async";
        img.className = "w-full h-64 object-cover rounded-xl transition group-hover:scale-105 duration-300";
        img.onerror = function() { this.onerror = null; this.src = fullSrc; };
        card.appendChild(img);

        const overlay = document.createElement("div");
        overlay.className = "absolute inset-0 bg-black/0 group-hover:bg-black/20 transition duration-300 rounded-xl";
        card.appendChild(overlay);

        const captionEl = document.createElement("div");
        captionEl.className = "absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent text-white text-xs p-3 opacity-0 group-hover:opacity-100 transition duration-300 rounded-b-xl";
        captionEl.textContent = caption;
        card.appendChild(captionEl);

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "delete-btn absolute top-2 right-2 w-8 h-8 rounded-full bg-black/40 border border-white/20 text-white text-sm opacity-0 group-hover:opacity-100 transition duration-300 hover:bg-red-500/80 flex items-center justify-center";
        deleteBtn.textContent = "üóë";
        deleteBtn.addEventListener("click", (e) => { e.stopPropagation(); promptDelete(photo.id); });
        card.appendChild(deleteBtn);

        card.addEventListener("click", () => openLightbox(photo.id, fullSrc, caption));
        grid.appendChild(card);
      }
    }

    // ‚îÄ‚îÄ Lightbox ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function openLightbox(photoId, src, caption) {
      currentPhotoId = photoId;
      const lb = document.getElementById("lightbox");
      const img = document.getElementById("lightboxImg");
      const cap = document.getElementById("lightboxCaption");

      img.src = src;
      cap.textContent = caption;
      lb.classList.remove("hidden");
      document.body.style.overflow = "hidden";
    }

    function closeLightbox(event) {
      if (event && event.target !== document.getElementById("lightbox")) return;
      document.getElementById("lightbox").classList.add("hidden");
      document.getElementById("lightboxImg").src = "";
      document.body.style.overflow = "";
      currentPhotoId = null;
    }

    // Close lightbox with Escape key
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        document.getElementById("lightbox").classList.add("hidden");
        document.getElementById("lightboxImg").src = "";
        document.body.style.overflow = "";
        currentPhotoId = null;
        closeDeleteModal();
        closeNoticeModal();
      }
    });

    function showNotice({ title = "Notice", message = "Something happened." } = {}) {
      document.getElementById("noticeTitle").textContent = title;
      document.getElementById("noticeMessage").textContent = message;
      document.getElementById("noticeModal").classList.remove("hidden");
    }

    function closeNoticeModal(event) {
      if (event && event.target !== document.getElementById("noticeModal")) return;
      document.getElementById("noticeModal").classList.add("hidden");
    }

    // ‚îÄ‚îÄ Delete ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function deleteCurrentPhoto() {
      if (!currentPhotoId) return;
      promptDelete(currentPhotoId);
    }

    function promptDelete(photoId) {
      currentPhotoId = photoId;
      const modal = document.getElementById("deleteModal");
      modal.classList.remove("hidden");

      document.getElementById("confirmDeleteBtn").onclick = async () => {
        await confirmDelete(photoId);
      };
    }

    function closeDeleteModal(event) {
      if (event && event.target !== document.getElementById("deleteModal")) return;
      document.getElementById("deleteModal").classList.add("hidden");
    }

    async function confirmDelete(photoId) {
      try {
        const res = await fetch("/api/photos", {
          method: "DELETE",
          headers: { "Content-Type": "application/json", "X-CSRF-Token": getCsrfToken() },
          body: JSON.stringify({ photo_id: photoId, confirm_delete: true }),
        });

        if (!res.ok) {
          const err = await res.json();
          showNotice({
            title: "Delete Failed",
            message: err.error || "Delete failed.",
          });
          return;
        }

        // Close both modals
        document.getElementById("deleteModal").classList.add("hidden");
        document.getElementById("lightbox").classList.add("hidden");
        document.getElementById("lightboxImg").src = "";
        document.body.style.overflow = "";
        currentPhotoId = null;

        // Reload gallery
        await loadGallery();

      } catch (e) {
        showNotice({
          title: "Request Failed",
          message: "Something went wrong.",
        });
      }
    }

    document.getElementById("sortBy").addEventListener("change", loadGallery);
    document.getElementById("sortOrder").addEventListener("change", loadGallery);

    loadGallery();
  </script>

</body>
</html>
